---
title: "Final Project"
author: "Xiaoshu Lin"
date: "2024-5-04"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(repos = "https://cloud.r-project.org/")
```

This final project is part of my ongoing research on understanding how science affects policy making using fishery policy in the US as a case study. I focus on climate vulnerability assessments (CVAs) as a subset of science due to the growing attention to climate resilience, adaptation and mitigation. The dataset was created by myself, after digging up relevant policy documents on NOAA.gov manually, identifying CVAs that have been cited, and constructing a counterfactual sample of CVAs that are not cited but share similar characteristics collected from Web of Science. The methodology is to find CVAs from the same journals. The dependent variable is binary cited or NOT cited. After consultation with my advisors and review of literature, I have identified 5 potential independent variables that might affect citation outcomes. Due to the narrow focus, I unfortunately have a small sample. Part of my results before I applied what I have learned from this class, has been interesting enough to be able to get presented at the 9th World Fishery Congress, and we hope to publish the rest on journals such as Marine Policy or others on par.

To start it off, I import raw data, review the data and clean the data by translating the year when papers were published into age and identify publications that focus on social aspect of climate vulnerability using keywords. Since all the publications were cited in 2016, the age is derived by 2016 minus the year published.

```{r}
library(readxl)
data <- read_excel("https://raw.githubusercontent.com/xl647/climate-vulnerability-assessments/tesy/climate_vulnerability_assessments.xlsx")
data$age<-2016-data$Publication_year
data$socioeconomic<-tolower(data$`Article Title`)
data$socioeconomic<-gsub(".*communit.*|.*fisher.*|social", "1", data$socioeconomic)
data$socioeconomic[data$socioeconomic!=1]<-0
data$socioeconomic<-as.numeric(data$socioeconomic)
data2<-data[,3:8]
```

Check correlations between each pair.

```{r}
library(corrplot)
sigcorr <- cor.mtest(data2[,1:6],conf.level = 0.9)
corrplot.mixed(cor(data2[,1:6],use = "pairwise.complete.obs"), upper = "ellipse", tl.col = "black", number.cex = .7, tl.pos = "lt", tl.cex=.7, p.mat = sigcorr$p, sig.level = .1)
```
There are statistically significant positive correlation between being US-focused and being quantitative, between citation and NOAA affiliation, between citation and a focus on the US, between NOAA affiliation and emphasis on socioeconomic vulnerability, and between NOAA affiliation and a focus on the US, with alpha=10%. There are statistically significant negative correlation between NOAA affiliation and age, with alpha=10%.

Run t-test for the correlations between citation and NOAA affiliation.
```{r}
t.test(data2$citation ~ data2$NOAA_affiliation)
```
The correlation is statistically significant at 5% level. 

Use a bootstrapped confidence interval to see if quantitative and qualitative research have different probability to have a focus on the US.

```{r}
diff <- rep(NA, 33)
for (i in 1:33) {
  squant <- sample(data2$US_focused[data2$quantitative==1], sum(data2$quantitative==1), replace=TRUE)
  squal <- sample(data2$US_focused[data2$quantitative==0], sum(data2$quantitative==0), replace=TRUE)
  diff[i] <- mean(squant)-mean(squal)
}
boot_ci <- quantile(diff, c(0.05, 0.95))
print(boot_ci)
```
The bootstrapped confidence interval does not span across zero. Quantitative and qualitative research indeed have different probability to focus on the US.

Use a permutation test to examine whether there is a significant difference between the probability of citation of CVAs with a focus on the US and the that of those without.

```{r}
actualdiff <- by(data2$citation, data2$US_focused, mean)
actualdiff <- actualdiff[1] - actualdiff[2]
diffvals <- rep(NA, 33)
for (i in 1:33) {
  fakeUS_focused <- sample(data2$US_focused)
  diffvals[i] <- mean(data2$citation[fakeUS_focused == "1"]) -  mean(data2$citation[fakeUS_focused == "0"])
}
permutation_ci <- quantile (diffvals, c(0.05, 0.95))
hist(diffvals, col = "palevioletred", main = "Permuted Sample Mean Diff in Citation Probability", xlab = "Difference in probability")
abline(v = actualdiff, col = "orchid4", lwd = 1)
abline(v = permutation_ci, col = "thistle", lwd = 1, lty=2)
text(actualdiff -0.02, 700 , paste("Actual Diff in Mean =", round(actualdiff,2)),srt = 90)
```
Whether the actual difference is outside the permutated confidence intervals changes every time the code is run, very likely due to the small sample. 


Next, I will try to find the best explained model through backward stepwise regression.

```{r}
model_1<-glm(citation~., data=data2, family="binomial")
summary(model_1)
```
Leave out the variable that has the largest p-value: quantitative.

```{r}
model_2<- glm(citation~NOAA_affiliation+US_focused+age+socioeconomic, data = data2, family = "binomial")
summary(model_2)
```
Leave out the variable that has the largest p-value: socioeconomic.

```{r}
model_3<- glm(citation~NOAA_affiliation+US_focused+age, data = data2, family = "binomial")
summary(model_3)
```
Leave out the variable that has the largest p-value: quantitative.
```{r}
model_4<- glm(citation~NOAA_affiliation+age, data = data2, family = "binomial")
summary(model_4)
```


Use a box plot to show the relationship between age and citation.

```{r}
boxplot(age~citation, data=data2, outlines=TRUE, col="paleturquoise")
```
It is hard to describe the difference. 

Use histogram to show the relationship between NOAA_affiliation and citation.

```{r}
temp <-table(data2[,c("citation", "NOAA_affiliation")])
colorcode <- c("olivedrab", "seagreen4")
barplot(temp, beside = TRUE, border = TRUE, col=colorcode, xlab = "Citation", names.arg =, axisname=TRUE )
legend("topright", legend = c("No NOAA Affiliation", "NOAA Affiliation"), fill = colorcode)
```
Science produced by NOAA affiliates are clearly favored over science that is not.

Examine whether the residuals of model 4 meet the heteroskedasticity assumption using a linear regression and normal quantile plot.

```{r}
fitted_value <- predict(model_2)
residuals <- resid(model_2)
heteroskedasticity_test <- lm (fitted_value ~ residuals)
summary(heteroskedasticity_test)
plot(fitted_value, residuals)
abline(h = 0, col = "steelblue")
myResPlots <- function(model, label){
  qqPlot(rstudent(model), pch = 19, main = paste("NQ Plot of Studentized Residuals,", label))
  plot(rstudent(model) ~ model$fitted.values, pch = 19, col = 'cadetblue', xlab = "Fitted Values", ylab = "Studentized Residuals",
     main = paste("Fits vs. Studentized Residuals,", label))
  abline(h = 0, lwd = 3)
  abline(h = c(2,-2), lty = 2, lwd = 2, col="skyblue")
  abline(h = c(3,-3), lty = 2, lwd = 2, col="lightcyan")

}

myResPlots(model_4, "Citation of CVAs in Policy Documents")
```
Our assumption about heteroskedasticity is roughly met. There seems to be two parallel lines, indicating a binary variables.

Estimate marginal effects.
```{r}
library(margins)
marginal_effect <- margins(model_4, type = "response")
summary(marginal_effect)
```
The result shows that a year increase in the age of the CVA is associated with 0.0485 increase in the probability of getting cited, statistically significant at 10% level. Having NOAA affiliates as authors increases the probability of getting cited by 0.4740, statistically significant at 0.1%.
`


















